%% Skript fuer Bildverarbeitung / Mapping

% rosinit('192.168.0.42') % ROS-Master aufziehen
%%
pixel_image_x = 723;
pixel_image_y = 543;
meter_image_x = 0.53; % [ m ]
meter_image_y = 0.4; % [ m ]
meter_per_pixel_x = meter_image_x / pixel_image_x;
meter_per_pixel_y = meter_image_y / pixel_image_y;
tennis_r_min = 25; % r_max muss < 3* r_min sein und r_max - r_min < 100
tennis_r_max = 75;
threshhold_golfball_bw = 0.18;

image_sub = rossubscriber('camera/image/compressed'); % subscribe zum Bild in komprimiertem Zustand    'sensor_msgs/CompressedImage'
image_msg_type = rosmessage('sensor_msgs/CompressedImage');
pause(1);

while (1)

image_msg = receive(image_sub, 1);
camera_image = readImage(image_msg);

% imshow(camera_image)
tennisball_pub = rospublisher('/tennisball', 'geometry_msgs/PointStamped');
tennisball_msg = rosmessage('geometry_msgs/PointStamped');
golfball_pub = rospublisher('/golfball', 'geometry_msgs/PointStamped');
golfball_msg = rosmessage('geometry_msgs/PointStamped');


%% Bildverarbeitung Tennisball

% figure(1)
% camera_image = imread('bild_2.png');
% image(camera_image)

[centers, radii, metric] = imfindcircles(camera_image, [tennis_r_min tennis_r_max]);
% viscircles(centers, radii, 'EdgeColor', 'b')
for object = 1:size(centers,1)
     tb_center_x_kp_meter = meter_per_pixel_x * centers(object,1);
     tb_center_y_kp_meter = meter_per_pixel_y * centers(object,2);
     tb_center_x_kc_meter = (tb_center_y_kp_meter - (meter_image_y / 2))*(-1);
     tb_center_y_kc_meter = (tb_center_x_kp_meter - (meter_image_x / 2))*(-1);
     
     % publishen tennisball
     tennisball_msg.Point.X = tb_center_x_kc_meter;
     tennisball_msg.Point.Y = tb_center_y_kc_meter;
     tennisball_msg.Header.Stamp = rostime('now');
     tennisball_msg.Header.FrameId = 'frontcamera_link';
     send(tennisball_pub, tennisball_msg)
end
%% Bildverarbeitung Golfball    

img_gray = rgb2gray(camera_image);
diff_im = imsubtract(camera_image(:,:,1), img_gray);
%Use a median filter to filter out noise
img_median = medfilt2(diff_im, [3 3]);
% Convert the resulting grayscale image into a binary image.
img_bw = im2bw(img_median, threshhold_golfball_bw); % 0.18 threshhold fuer black and white
% Remove all those pixels less than 300px
img_closed = bwareaopen(img_bw,300);
    
% subplot(3,2,1),imshow(diff_im)
% subplot(3,2,2),imshow(img_median)
% subplot(3,2,3),imshow(img_bw)
% subplot(3,2,4),imshow(img_closed)
% subplot(3,2,5),imshow(img_gray)
% subplot(3,2,6),imshow(camera_image)
%Label all the connected components in the image.
bw = bwlabel(img_closed, 8);
    
% Here we do the image blob analysis.
% We get a set of properties for each labeled region.
stats = regionprops(bw, 'BoundingBox', 'Centroid');
    
% Display the image
% figure(2)

% imshow(camera_image)
    
% hold on

%This is a loop to bound the red objects in a rectangular box.
for object = 1:length(stats)
     bb = stats(object).BoundingBox;
     bc = stats(object).Centroid;
%      rectangle('Position',bb,'EdgeColor','r','LineWidth',2)
%      plot(bc(1),bc(2), '-m+')
%      a=text(bc(1)+15,bc(2), strcat('X: ', num2str(round(bc(1))), '    Y: ', num2str(round(bc(2)))));
%      set(a, 'FontName', 'Arial', 'FontWeight', 'bold', 'FontSize', 12, 'Color', 'yellow');
     
     % umrechnen Pixel in m
     gb_center_x_kp_meter = meter_per_pixel_x * bc(1);
     gb_center_y_kp_meter = meter_per_pixel_y * bc(2);
     gb_center_x_kc_meter = (gb_center_y_kp_meter - (meter_image_y / 2))*(-1);
     gb_center_y_kc_meter = (gb_center_x_kp_meter - (meter_image_x / 2))*(-1);
     
     % publishen golfball
     golfball_msg.Point.X = gb_center_x_kc_meter;
     golfball_msg.Point.Y = gb_center_y_kc_meter;
     golfball_msg.Header.Stamp = rostime('now');
     golfball_msg.Header.FrameId = 'frontcamera_link';
     send(golfball_pub, golfball_msg)
end
    
% hold off

end
%% Bildverarbeitung mit Schwarz-Weiï¿½-Bild
% camera_image_gray = rgb2gray(camera_image);
% level = graythresh(camera_image_gray);
% BW = imbinarize(camera_image_gray, level);
% imshowpair(camera_image_gray, BW, 'montage')