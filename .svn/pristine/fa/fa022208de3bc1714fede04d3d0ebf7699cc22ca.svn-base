function [] = ConnectToVRep()
global cmd_vel_sub;
global ptu_cmd_sub;
global ptree;
global clientID;
global vrep;
global polling_timer;

global simulink_model;
simulink_model = 'fre2017';

    disp('Program started');
    vrep=remApi('remoteApi'); % using the prototype file (remoteApiProto.m)
    vrep.simxFinish(-1); % just in case, close all opened connections
    clientID=vrep.simxStart('127.0.0.1',19997,true,true,5000,5);
    set_param(simulink_model,'FixedStep', '0.1')
    set_param(simulink_model,'SimulationCommand', 'start');
    set_param(simulink_model,'SimulationCommand', 'pause');

    if (clientID>-1)
        disp('Connected to remote API server');
        vrep.simxStartSimulation(clientID, vrep.simx_opmode_oneshot);
        vrep.simxSynchronous(clientID, true);
        vrep.simxGetStringSignal(clientID,'laser',vrep.simx_opmode_streaming); % Initialize streaming
        vrep.simxGetFloatSignal(clientID,'pPan',vrep.simx_opmode_streaming); % Initialize streaming
        vrep.simxGetFloatSignal(clientID,'pTilt',vrep.simx_opmode_streaming); % Initialize streaming
        
        cmd_vel_sub = rossubscriber('/cmd_vel',@cmd_vel_callback_sync); 
        ptu_cmd_sub = rossubscriber('/ptu/cmd',@ptu_cmd_callback);
        
        polling_timer = timer('ExecutionMode', 'fixedDelay', 'Period', 0.5);
        polling_timer.TimerFcn = @timer_callback;
        start(polling_timer);
    else
        disp('Failed connecting to remote API server');
    end
end


function cmd_vel_callback_sync(sub, msg)
global clientID;
global vrep;

    vel_x = msg.Linear.X;
    vel_alpha = msg.Angular.Z;
    wheel_dist = 0.33;
    wheel_diameter = 0.195; %aus vrep
    left_vel = (vel_x - vel_alpha*wheel_dist/2)/(wheel_diameter/2);
    right_vel = (vel_x + vel_alpha*wheel_dist/2)/(wheel_diameter/2);
    vrep.simxSetFloatSignal(clientID,'vLeft', left_vel, vrep.simx_opmode_oneshot);
    vrep.simxSetFloatSignal(clientID,'vRight', right_vel, vrep.simx_opmode_oneshot);
    read_from_vrep();
end


function ptu_cmd_callback(sub, msg)
global clientID;
global vrep;

    pPan = msg.Position(1);
    pTilt = msg.Position(2);
    vrep.simxSetFloatSignal(clientID,'pPan', pPan, vrep.simx_opmode_oneshot);
    vrep.simxSetFloatSignal(clientID,'pTilt', pTilt, vrep.simx_opmode_oneshot);
    vPan = msg.Velocity(1);
    vTilt = msg.Velocity(2);
    vrep.simxSetFloatSignal(clientID,'vPan', vPan, vrep.simx_opmode_oneshot);
    vrep.simxSetFloatSignal(clientID,'vTilt', vTilt, vrep.simx_opmode_oneshot);
    read_from_vrep();
end

function timer_callback(obj, event)
global clientID;
global vrep;
global simulink_model;

   set_param(simulink_model,'SimulationCommand', 'step');
   vrep.simxSynchronousTrigger(clientID);
end